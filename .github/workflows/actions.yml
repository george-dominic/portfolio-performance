name: portfolio-performance

on:
  schedule:
    - cron: '7 21 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: checkout repo content
        uses: actions/checkout@v2

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: run python and generate prompt
        id: generate_prompt
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
        run: |
          python prep_prompt_action.py
          echo "prompt_output=$(<prompt.txt)" >> $GITHUB_OUTPUT

      - name: Run Ollama with prompt
        id: ollama
        uses: ollama/ollama-action@v1
        with:
          model: llama3.2
          prompt: ${{ steps.generate_prompt.outputs.prompt_output }}

      - name: Send email using LLM response
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          MARKETAUX_API_KEY: ${{ secrets.MARKETAUX_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        run: |
          echo "${{ steps.ollama.outputs.response }}" > response.txt
          python prep_email_action.py
